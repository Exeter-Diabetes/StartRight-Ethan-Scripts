---
title: "Investigating whether T1D models can identify T2-misdiagnoses."
author: "Ethan de Villiers"
date: "`r Sys.Date()`"
output: html_document
---
# Introduction


## Init

``` {r Packages}
library(tidyverse) # streamlining R coding since 2016
library(rio) # Import/Output master package
library(psych) # Essential for descriptive stats
library(pROC) # ROC curves and such.
library (rsq) # Used for R-squared values
library(ggplot2) # Advanced Graphs
library(tableone) # Nice descriptives for tables
library(rms) # Val.prob mainly
# library(val.prob) Out dated for this version of R - useful for calibration 
```

``` {r ImportingData}
filepath = 'startight Aug 22 comma separated.csv'
my_data <- import(filepath)

#> View(my_data)
```

## Prepping Data

Notes on Data
- age_atdiag is the exact patient age in double form
- AgeatDiagnosis is the patient age in int form (used)
- In equations where AGE is used, AgeatDiag was used instead - need to fix!
- no current clean GAD, ZNT8 code
- Islet autoantibodies were considered positive if: 
  - GADA ≥11 units/mL, IA2A ≥7.5 units/mL and ZNT8A ≥65 units/mL in those aged up to 30 years and ≥10 units/mL in those aged ≥30 years (17, 18)
- GRS Scores:
  - Correct GRS version = variable: "GRS"
  - No current, calibrated/standardised GRS scores against a type-1 enriched cohort

``` {r Cleaning and Prepping Data}
# Creating Anibody columns ####
#New column GADA_Status will default to NA, and if negative = 0, positive = 1
my_data = my_data %>%
  mutate(GAD_status = ifelse(GAD == 'negative', 0, NA)) %>%
  mutate(GAD_status = ifelse(grepl("[0-9]",GAD) & as.numeric(GAD) >= 11, 1, GAD_status))

#New column IA2_status will default to NA, and if negative = 0, positive = 1
my_data = my_data %>%
  mutate(IA2_status = ifelse(IA2 == 'negative', 0, NA)) %>%
  mutate(IA2_status = ifelse(grepl("[0-9]",IA2) & as.numeric(IA2) >= 7.5, 1, IA2_status))

#New column ZNT8_Status will default to NA, and if negative = 0, positive = 1
my_data = my_data %>%
  mutate(ZNT_status = ifelse(ZNT8 == 'negative', 0, NA)) %>%
  mutate(ZNT_status = ifelse(grepl("[0-9]",ZNT8) & as.numeric(ZNT8) >= 65, 1, ZNT_status))

#Filling in BMI for missing values
my_data = my_data %>%
  mutate(BMI = ifelse(is.na(BMI), Weight / (Height^2), BMI))

#Creating column for how many antibodies a patient has, sum()
my_data$Number_Antibodies = rowSums(my_data[,c("GAD_status", "IA2_status", "ZNT_status")], na.rm=TRUE)

#Creating binary column for if patients received any antibody testing
my_data = my_data %>%
  mutate(antibodies_tested = ifelse(!is.na(GAD_status) | !is.na(IA2_status) | !is.na(ZNT_status), 1, 0 ) )

#Creating Binary outcome if patients were at least 1 antibody positive
my_data = my_data %>%
  mutate(Antibody_Positive = ifelse(Number_Antibodies >= 1, 1, 0))

#> Calibrating GRS-Scores
#Creating Type-1 enriched cohort
type_1_control_cohort = my_data %>%
  filter(Insulin == "Yes" & Number_Antibodies >= 2 & Type_of_diabetes == "Type 1") %>%
  filter(SCORE != '' & !is.na(SCORE)) # n = 456

#Calibrating GRS-Scores (pnorm())
my_data$Calibrated_GRS_Centiles = pnorm(my_data$SCORE, mean = mean(type_1_control_cohort$SCORE), sd = sd(type_1_control_cohort$SCORE))

#Calculating Time To Insulin - Date_of_diagnosis until Date_continuous insulin
# - Slightly problematic as only 134 patients have data for Date_continuous_insulin
my_data = my_data %>%
  mutate(Time_to_insulin = difftime(
    as.Date(Date_continuous_insulin, "%d-%b-%y"),
    as.Date(DateofDiagnosis, "%d-%b-%y"),
    units = "weeks")
  ) %>%
  mutate(Time_to_insulin = as.numeric(Time_to_insulin)) %>%
  mutate(Time_to_insulin = ifelse(Time_to_insulin < 0, 0, Time_to_insulin))

# Calculating Duration of Diabetes - Date of diagnosis until final clinic date = YEARS
my_data = my_data %>%
  mutate(Duration_diabetes = ifelse(
    !is.na(V3Date_Contacted), 
    as.numeric(
      difftime(
        as.Date(V3Date_Contacted, "%d/%m/%Y"),
        as.Date(DateofDiagnosis, "%d-%b-%y"),
        units = "weeks"
      )/52
    ),
    as.numeric(
      difftime(
        as.Date(V2Date_Contacted, "%d/%m/%Y"),
        as.Date(DateofDiagnosis, "%d-%b-%y"),
        units = "weeks"
      )/52
    ))
  )

#> UNCOMMENT the following line to calculate Median duration of Diabetes = 2.5 years:
# median(my_data$Duration_diabetes, na.rm = TRUE)

# Calculating Median follow-up time from study
my_data = my_data %>%
  mutate(Duration_followup = ifelse(
    !is.na(V3Date_Contacted), 
    as.numeric(
      difftime(
        as.Date(V3Date_Contacted, "%d/%m/%Y"),
        as.Date(Date_Visit, "%d-%b-%y"),
        units = "weeks"
      )/52
    ),
    as.numeric(
      difftime(
        as.Date(V2Date_Contacted, "%d/%m/%Y"),
        as.Date(Date_Visit, "%d-%b-%y"),
        units = "weeks"
      )/52
    ))
  )

#> UNCOMMENT the following line to calculate Median duration of follow up = 2.1 years:
# median(my_data$Duration_followup, na.rm = TRUE)
```

Models Section:
This section generates and applies models that were previously developed. Although there are 7 models applied to this study, only 3 were included for the final abstract submission and presentation for Diabetes UK.

The models were taken from a previous study (found in Supplemental Material):
Lynam A, McDonald T, Hill A, Dennis J, Oram R, Pearson E, et al. Development and validation of multivariable clinical diagnostic models to identify type 1 diabetes requiring rapid insulin therapy in adults aged 18–50 years [Internet]. BMJ Open. British Medical Journal Publishing Group; 2019 [cited 2023Apr12]. Available from: https://bmjopen.bmj.com/content/9/9/e031586 

The models investigated that were INCLUDED in the presentation and abtract are as follows:
- Clinical Features Model:
  - = 37.94 + (-5.09 * log(age at diagnosis)) + (-6.34 * log(BMI))

- Clinical Features + Anti Model:
  - = 33.49649577 + (-4.665598345 * Log(Age)) + (-5.81137397 * Log(BMI)) + (3.082366 * AntiStatus1‡) + (3.494462 * AntiStatus2‡) + (4.350717 * AntiStatus3‡)
  - ‡where‡: AntiStatus1 = GAD +ve only, AntiStatus2 = IA-2 +ve only, AntiStatus3 = Both GADA and IA-2 +ve

- Clinical Features + Anti + GRS Model:
  - = 21.57649882 + (-4.086215772 * log(Age)) + (-5.096252172 * log(BMI)) + (2.702010666 * AntiStatus1‡) + (3.063255174 * AntiStatus2‡) + (3.813850704 * AntiStatus3‡) + (30.11052 * GRS)
  - ‡where‡: AntiStatus1 = GAD +ve only, AntiStatus2 = IA-2 +ve only, AntiStatus3 = Both GADA and IA-2 +ve

The models investigated that were NOT INCLUDED in the presentation and abtract are as follows:
- Clinical Features + GAD Model
  - = 34.8057844720 + (-4.801441792 * log (Age at diagnosis)) + (-5.980577792 * log(BMI)) + (2.937107976 * GADA)

- Clinical Features + IA2 Model
  - = 37.26905033 + (3.194096 * IA2† ) + (-5.047657308 * Log(Age)) + (-6.287258808 * Log(BMI))

- Clinical Features + GRS Model
  - = 24.46138054 + (-4.443506884 * Log(Age)) + (-5.534741384 * Log(BMI)) + (33.93968* T1D GRS)

- Clinical Features + Lipids Model
  - = 9.0034272  - (0.1915482 * BMI) – (0.1686227 * age at diagnosis) + (0.3026012 if female) – (0.2269216 * cholesterol) + (1.540850 * HDL) – (0.2784059 * triglycerides)

``` {r Generating Model LogOdds}
#> This section is split into two sub-sections
#>  - The first subsection is reserved for models that WERE INCLUDED
#>  - The second subsection is reserved for models NOT INCLUDED

my_data = my_data %>% 
  mutate(
    logOR_clinF = 37.94 +
      (-5.09*log(AgeatDiagnosis)) +
      (-6.34 * log(BMI)) 
  ) %>% # First Model: Clinical Features alone (Age + BMI)
  mutate( 
    logOR_clinF_Antibodies = 33.49649577 +
            (-4.665598345 * log(AgeatDiagnosis)) +
            (-5.81137397 * log(BMI)) +
            (3.082366 * GAD_status) +
            (3.494462 * IA2_status) +
            (4.350717 * ifelse(Number_Antibodies >= 2, 1, 0))
  ) %>% # Fourth Model: ClinF and Antibodies (Age, BMI, GAD, IA2)
  mutate(
    logOR_clinF_antiGRS = 21.57649882 +
            (-4.086215772 * log(AgeatDiagnosis)) +
            (-5.096252172 * log(BMI)) +
            (2.702010666 * GAD_status) +
            (3.063255174 * IA2_status) +
            (3.813850704 * ifelse(Number_Antibodies >= 2, 1, 0)) +
            (30.11052 * GRS)
  ) # Fifth Model: ClinF + Anti + GRS (Age, BMI, GAD, IA2, GRS)
  

#> This is the start of the second section for Models that WERE NOT INCLUDED  
my_data = my_data %>%
  mutate(
    logOR_clinF_GAD = 34.8057844720 +
      (-4.801441792 * log (AgeatDiagnosis)) +
      (-5.980577792 * log(BMI)) +
      (2.937107976 * GAD_status)
  ) %>% # Second Model: ClinF and GAD (Age, BMI, GAD)
  mutate(
    logOR_clinF_IA2 = 37.26905033 +
      (3.194096 * IA2_status ) +
      (-5.047657308 * log(AgeatDiagnosis)) +
      (-6.287258808 * log(BMI))
  ) %>% # Third Model: ClinF and IA2 (Age, BMI, IA2)
  mutate(
    logOR_clinF_GRS = 24.46138054 +
      (-4.443506884 * log(AgeatDiagnosis)) +
      (-5.534741384 *log(BMI)) +
      (33.93968* GRS)
  ) %>% # Sixth Model: ClinF + GRS
  mutate(
    logOR_clinF_Lipids = 9.0034272 -
      (0.1915482*BMI) -
      (0.1686227* AgeatDiagnosis) +
      (0.3026012 * ifelse(Gender == "Female", 1, 0)) -
      (0.2269216*Cholesterol_at_diag) +
      (1.540850*HDL_at_diag) -
      (0.2784059*Triglycerides_at_diag)
  ) # Seventh Model: ClinF + Lipids
```

``` {r Calculating Model Probabilities from logOdds Ratio}
#> To calculate model probability from the previous LogOdds, the following formula must be applied:
#>  - exp(LogOR) / (1 + exp(LogOR)
my_data = my_data %>%
  mutate(model_clinF = exp(logOR_clinF) / (1 + exp(logOR_clinF))) %>%
  mutate(model_clinF_GAD = exp(logOR_clinF_GAD) / (1 + exp(logOR_clinF_GAD))) %>%
  mutate(model_clinF_IA2 = exp(logOR_clinF_IA2) / (1 + exp(logOR_clinF_IA2))) %>%
  mutate(model_clinF_Anti = exp(logOR_clinF_Antibodies) / (1 + exp(logOR_clinF_Antibodies))) %>%
  mutate(model_clinF_AntiGRS = exp(logOR_clinF_antiGRS) / (1 + exp(logOR_clinF_antiGRS))) %>%
  mutate(model_clinF_GRS = exp(logOR_clinF_GRS) / (1 + exp(logOR_clinF_GRS))) %>%
  mutate(model_clinF_Lipids = exp(logOR_clinF_Lipids) / (1 + exp(logOR_clinF_Lipids)))
```

Non-Insulin Cohort Building

This following section is where the initially non-insulin treated cohort is created.
 - Patients who are Initially treated != (not as) Insulin
 - Removing patients who have Date continuous Insulin within 2 weeks of their Diagnosis



``` {r Non-Insulin Cohort Building}
#> Non-Insulin cohort referred to as "Type2_cohort" for remainder of script

#Type_2 = any patient initially NOT treated with Insulin
Type2_cohort = my_data %>%
  filter(Initial_diabetes_Insulin != "Insulin")

# Removing those who have a time_to_insulin of less than 2 weeks
Type2_cohort = Type2_cohort %>%
  filter(is.na(Time_to_insulin) | Time_to_insulin > 2)

# Filter patients with Visit 1 positive insulin, where visit 1 is >= 2 weeks from diagnosis
Type2_cohort = Type2_cohort %>%
  filter(as.numeric(
      difftime(
        as.Date(Date_Visit, "%d-%b-%y"),
        as.Date(DateofDiagnosis, "%d-%b-%y"),
        units = "weeks"
      )) > 2 | Insulin != "Yes"
  ) 

#> CREATING PROGRESSION OUTCOME:
#>  - Binary outcome if patients progressed to Insulin or Not
#>  - If Insulin == "Yes", patients have progressed to Insulin on Visit 1
#>  - If V3Insulin == "Yes", patients have progressed by the end of the study
#>  - If there is no available data for V3, Use V2Insulin
Type2_cohort = Type2_cohort %>%
  mutate(progressed = ifelse( # If on Insulin by study recruitment, progressed
    Insulin == "Yes",
    1,
    ifelse(
      V3Insulin == "Yes", # If on Insulin by Final Visit (V3) recruitment, progressed
      1,
      ifelse(
        V2Insulin == "Yes", # If no data on V3, if Insulin by V2, progressed
        1,
        0
      )
    )
  ))

#> UNCOMMENT FOLLOWING LINE: See total number of progressed patients = 141
# nrow(Type2_cohort %>% filter(progressed == 1))
# nrow(Type2_cohort %>% filter(progressed == 0))

#> UNCOMMENT FOLLOWING LINES: See total number of progressed patients who had model outcomes = 
# nrow(Type2_cohort %>% filter(progressed == 1 & !is.na(model_clinF)))
# nrow(Type2_cohort %>% filter(progressed == 1 & !is.na(model_clinF_Anti)))
# nrow(Type2_cohort %>% filter(progressed == 1 & !is.na(model_clinF_AntiGRS)))
# nrow(Type2_cohort %>% filter(progressed == 1 & !is.na(model_clinF) & !is.na(model_clinF_Anti) & !is.na(model_clinF_AntiGRS)))

#> UNCOMMENT FOLLOWING LINES: See total number of progressed patients who had model outcomes = 
# nrow(Type2_cohort %>% filter(progressed == 0 & !is.na(model_clinF)))
# nrow(Type2_cohort %>% filter(progressed == 0 & !is.na(model_clinF_Anti)))
# nrow(Type2_cohort %>% filter(progressed == 0 & !is.na(model_clinF_AntiGRS)))
# nrow(Type2_cohort %>% filter(progressed == 0 & !is.na(model_clinF) & !is.na(model_clinF_Anti) & !is.na(model_clinF_AntiGRS)))

# Looking at Cohort
# View(Type2_cohort)
```

## Data Analysis

###Descriptive Statistics
``` {r Type-2 Cohort Baseline Table}
table = print(
  CreateTableOne(
    data=Type2_cohort,
    vars = c("BMI", "AgeatDiagnosis", "GRS", "HbA1c_at_diagnosis"),
    strata = "progressed"
  ),
  test = FALSE,
  noSpaces = TRUE
)

write.csv(table, file = "testTable.csv")
#> Take .CSV file and upload text to: 
#> https://www.becsv.com/csv-table.php
#> Generate and HTML table, and download to an .htm document
#> Open doc and copy/paste HTML table into word --> powerpoint :)
#> OR open .csv in Excel and copy paste across

#> Calculating How many were single/double antibody positive/negative
#> To use this section:
#>  - change progressed == either 1 or 0 to select different cohorts
#>  - change number_antibodies >= 2, == 1, or >=1 for different descriptives
nrow(
  Type2_cohort %>%
    filter(progressed == 0) %>%
    filter(Number_Antibodies == 1)
)

```

### Models Section

``` {r Creating ROC_DATA dataframe for ROC Cohort}
# Creating a new dataframe to work with cohort that has ALL Model outcomes
roc_data = Type2_cohort %>%
  filter(!is.na(progressed) &!is.na(model_clinF) & !is.na(model_clinF_Anti) &
           !is.na(model_clinF_AntiGRS) ) %>%
  mutate(Multi_Antibody_Positive = ifelse(Number_Antibodies >= 2, 1, 0))
```

``` {r 1: Clinical Features Model}
#> This section dedicated to the Clin F slide
#> Incorporates: ROC and ggBoxPlot
#>  - To view/generate Calibration plot, please proceed to Chunk 18, titled: "Model Calibration Plots by Deciles"

# ROC AUC
glm.fit = glm(roc_data$progressed ~ roc_data$model_clinF, family = binomial())
plot.new()
lines(roc_data$model_clinF, glm.fit$fitted.values)

(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

#Distribution 2.0: Boxplot
ggplot(Type2_cohort %>%
         mutate(progressed = ifelse(progressed == 0,
                                    "Did not Progress",
                                    "Progressed")
                )
        ,aes(x=as.factor(progressed),y=model_clinF)
       ) + 
  geom_boxplot() +
  ylab("Clinical Features Model Probability") +
  xlab("Progression to Insulin <= 3 years")



```

``` {r 2: Clin F + GAD Model}
#> This section dedicated to the Clin F + slide
#> Incorporates: ROC, Calibration, and ggViolin
Type2_cohort$model_clinF_GAD

#Distribution 2.0: Boxplot
ggplot(Type2_cohort, aes(as.factor(progressed), model_clinF_GAD)) +
  geom_boxplot() +
  xlab("Progressed (0=False)")

# ROC AUC
glm.fit = glm(roc_data$progressed ~ roc_data$model_clinF_GAD, family = binomial())
plot.new()
lines(roc_data$model_clinF_GAD, glm.fit$fitted.values)

(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

# Calibration
val.prob(roc_data$model_clinF_GAD, roc_data$progressed)
```

``` {r 3: Clin F + IA2 Model}
#> This section dedicated to the Clin F + slide
#> Incorporates: ROC, Calibration, and ggViolin
Type2_cohort$model_clinF_IA2

#Distribution 2.0: Boxplot
ggplot(Type2_cohort, aes(as.factor(progressed), model_clinF_IA2)) +
  geom_boxplot() +
  xlab("Progressed (0=False)")

# ROC AUC
glm.fit = glm(roc_data$progressed ~ roc_data$model_clinF_IA2, family = binomial())
plot.new()
lines(roc_data$model_clinF_IA2, glm.fit$fitted.values)

(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

#Calibration
val.prob(roc_data$model_clinF_IA2, roc_data$progressed)
```

``` {r 4: Clin F + GAD and IA2 Model}
#> This section dedicated to the Clin F + slide
#> Incorporates: ROC, Calibration, and ggViolin
Type2_cohort$model_clinF_Anti

#Distribution 2.0: Boxplot
ggplot(Type2_cohort %>%
         mutate(progressed = ifelse(progressed == 0,
                                    "Did not Progress",
                                    "Progressed")
                )
        , aes(as.factor(progressed), model_clinF_Anti)) +
  geom_boxplot() +
  xlab("Progression to Insulin <= 3 years") +
  ylab("Clinical Features + Antibodies Model Probability")

# ROC AUC
glm.fit = glm(roc_data$progressed ~ roc_data$model_clinF_Anti, family = binomial())
plot.new()
lines(roc_data$model_clinF_Anti, glm.fit$fitted.values)

(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

nrow(roc_data %>% filter(progressed == 1))

#Calibration
val.prob(roc_data$model_clinF_Anti, roc_data$progressed)
```

``` {r 5: Clin F + Anti + GRS Model}
#> This section dedicated to the Clin F + slide
#> Incorporates: ROC, Calibration, and ggViolin
Type2_cohort$model_clinF_AntiGRS

#Distribution 2.0: Boxplot
ggplot(Type2_cohort %>%
         mutate(progressed = ifelse(progressed == 0,
                                    "Did not Progress",
                                    "Progressed")
                )
        , aes(as.factor(progressed), model_clinF_AntiGRS)) +
  geom_boxplot() +
  xlab("Progression to Insulin <= 3 years") +
  ylab("Clinical Features + Anti + GRS Model Probability")

#ROC AUC

glm.fit = glm(roc_data$progressed ~ roc_data$model_clinF_AntiGRS, family = binomial())
plot.new()
lines(roc_data$model_clinF_AntiGRS, glm.fit$fitted.values)

(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')


#Calibration
val.prob(roc_data$model_clinF_AntiGRS, roc_data$progressed)
```

``` {r 6: Clin F + GRS Model}
#> This section dedicated to the Clin F + GRS slide
#> Incorporates: ROC, Calibration, and ggBox
Type2_cohort$model_clinF_GRS

#Distribution 2.0: Boxplot
ggplot(Type2_cohort, aes(as.factor(progressed), model_clinF_GRS)) +
  geom_boxplot() +
  xlab("Progressed (0=False)") +
  ylab("Clin F + GRS Model Probabilities")

# ROC AUC
glm.fit = glm(roc_data$progressed ~ roc_data$model_clinF_GRS, family = binomial())
plot.new()
lines(roc_data$model_clinF_GRS, glm.fit$fitted.values)

(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

# Calibration
val.prob(roc_data$model_clinF, roc_data$progressed)

nrow(Type2_cohort)

```

``` {r 7: Clin F + Lipids}
#> This section dedicated to the Clin F + GRS slide
#> Incorporates: ROC, Calibration, and ggBox
Type2_cohort$model_clinF_Lipids

#Distribution 2.0: Boxplot
ggplot(Type2_cohort, aes(as.factor(progressed), model_clinF_Lipids)) +
  geom_boxplot() +
  xlab("Progressed (0=False)") +
  ylab("Clin F + Lipids Model Probabilities") +
  ylim(c(0,1))

# ROC AUC
glm.fit = glm(roc_data$progressed ~ roc_data$model_clinF_Lipids, family = binomial())
plot.new()
lines(roc_data$model_clinF_Lipids, glm.fit$fitted.values)

(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

```


``` {r Investigating If Antibodies Can Identify Progression}
#> ggBoxPlot for antibody distribution
ggplot(Type2_cohort, aes(as.factor(progressed), Number_Antibodies)) +
  geom_boxplot() +
  xlab("Progressed (0=False)") +
  ylab("Number of Positive Antibodies")


#> AUC ROC for Antibodies to compare
roc_data = Type2_cohort %>%
  filter(!is.na(Number_Antibodies) )

glm.fit = glm(roc_data$progressed ~ roc_data$Number_Antibodies, family = binomial())
plot.new()
lines(roc_data$Number_Antibodies, glm.fit$fitted.values)

(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

```


``` {r Investigating antibodies tested}
#> Objective is to look at those patients who have had antibodies tested
#> Measure and look at how ineffective general screening is, and how implementing
#> models can overcome this inefficiency.

table = print(
  CreateTableOne(
    data=Type2_cohort,
    vars = c("BMI", "AgeatDiagnosis", "GRS", "HbA1c_at_diagnosis"),
    strata = "antibodies_tested"
  ),
  test = FALSE,
  noSpaces = TRUE
)

write.csv(table, file = "testTable.csv")

#> Calculating How many were single/double antibody positive/negative
nrow(
  Type2_cohort %>%
    filter(antibodies_tested == 1) %>%
    filter(Number_Antibodies >= 2)
)
```

``` {r Model Calibration Plots by Deciles}
#> To Use following section:
#>  - Reassign model_probabilities variable to your chosen Model Probs
#>  - Change the labs( title = "") on line 544 to your title
model_probabilities = Type2_cohort$model_clinF_AntiGRS

quantiles <- quantile(model_probabilities, probs = seq(0, 1, by = 0.1), na.rm = TRUE)
quantiles[1] <- 0.99 * quantiles[1]
quantiles[length(quantiles)] <- 1.1 * quantiles[length(quantiles)]
processed_quantiles <- cut(
  model_probabilities,
  breaks = quantiles,
  include_lowest = TRUE
)
processed_quantiles <- data.frame(y = Type2_cohort$progressed, pred = model_probabilities, dec = processed_quantiles) %>%
  group_by(dec) %>%
  mutate(prob_obs = sum(y) / n(),
    obs = sum(y),
    n_group = n(),
    mnpred = mean(pred),
    lower = lapply(sum(y), prop.test, n = n()),
    upper = sapply(lower, function(x) x$conf.int[2]),
    lower = sapply(lower, function(x) x$conf.int[1]))
## plot
ggplot(processed_quantiles, aes(x = mnpred, y = prob_obs)) +
  geom_point() +
  xlab("Mean predicted probability in each decile") +
  ylab("Observed probability in each decile") +
  labs(title = "Clin F + Anti + GRS Model Cal. Plot") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  ylim(c(0, 1)) + xlim(c(0, 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper))

```

``` {r Antibodies Interpretation: Applying Models to Anti+ Cohort}
#> This section meant to test whether antibodies model offers anything after patients received an antibody result
#> ROC curve and box plot WITHIN antibody positive patients
Type2_cohort$model_clinF_Anti
Type2_cohort$Antibody_Positive

#Distribution 2.0: Boxplot
ggplot(
  Type2_cohort %>% filter(Antibody_Positive == 1),
  aes(as.factor(progressed),
  model_clinF_AntiGRS
)) +
  geom_boxplot() +
  xlab("Progressed (0=False)") +
  ylab("Clin F + Antibodies Model Probabilities") +
  ylim(c(0,1))

#> ROC AUC
# Creating temporary dataframe for this special section - not to mess with other Roc Data and associated ROC curves
temp_roc_data = roc_data %>%
  filter(Antibody_Positive == 1)

current_model = temp_roc_data$model_clinF_AntiGRS

glm.fit = glm(temp_roc_data$progressed ~ current_model, family = binomial())
plot.new()
lines(current_model, glm.fit$fitted.values)

(roc = roc(temp_roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

remove(temp_roc_data)

```

``` {r 2nd Flowchart: Applying Antibodies Model to FlowChart}
#> This Section is designed to calculate descriptive statistics for each group of the cohort
#>  - intending to see how applying Antibodies model discriminates those who progress vs those who dont
#>  - need to apply model to all groups: High | low risk & Antibody+ | Antibody-

screening_threshold = 0.05
antibody_threshold = 0.05
antibody_status = 1
risk = "low"


nrow(
  Type2_cohort %>%
    filter(if (risk == "high") model_clinF >= screening_threshold else model_clinF < screening_threshold) %>%
    filter(Antibody_Positive == antibody_status)
)

nrow(
  Type2_cohort %>%
    filter(if (risk == "high") model_clinF >= screening_threshold else model_clinF < screening_threshold) %>%
    filter(Antibody_Positive == antibody_status) %>%
    filter(model_clinF_Anti >= antibody_threshold)
)

nrow(
   Type2_cohort %>%
    filter(if (risk == "high") model_clinF >= screening_threshold else model_clinF < screening_threshold) %>%
    filter(Antibody_Positive == antibody_status) %>%
    filter(progressed == 1)
)

nrow(
   Type2_cohort %>%
    filter(if (risk == "high") model_clinF >= screening_threshold else model_clinF < screening_threshold) %>%
    filter(Antibody_Positive == antibody_status) %>%
    filter(progressed == 1) %>%
    filter(model_clinF_Anti >= antibody_threshold) 
)

# TEMP TEST
```

``` {r Model Calibrations by Deciles}
#> Changes - Don't graph according to model probability, but decile of population
#> Can do this using ntile() function

results = list()

#> Generating ntiles
Type2_cohort = Type2_cohort %>%
  mutate(model_clinF_percentiles = ntile(model_clinF, 10)) %>%
  mutate(model_clinF_Anti_percentiles = ntile(model_clinF_Anti, 10)) %>%
  mutate(model_clinF_AntiGRS_percentiles = ntile(model_clinF_AntiGRS, 10))

table(Type2_cohort$model_clinF_percentiles)

Type2_cohort %>%
  filter(model_clinF_percentiles == 5) %>%
  select(model_clinF) %>%
  describe()

nrow(Type2_cohort %>%
  filter(model_clinF_percentiles == 5 & progressed == 1))
  

nrow(Type2_cohort %>%
  filter(model_clinF_percentiles == 0.2))


# Need to initialize new column so loop works
Type2_cohort$model_clinF_percentiles_results = NA
Type2_cohort$model_clinF_Anti_percentiles_results = NA
Type2_cohort$model_clinF_AntiGRS_percentiles_results = NA

# Loop to calculate % progressed in CLIN F MODEL
for (x in 1:10){
  total = Type2_cohort %>%
      filter(model_clinF_percentiles == x) %>%
      nrow()
    
    antibody = Type2_cohort %>%
      filter(model_clinF_percentiles == x & progressed == 1) %>%
      nrow()
    
    Type2_cohort = Type2_cohort %>%
      mutate(model_clinF_percentiles_results = ifelse(
        model_clinF_percentiles == x,
        antibody/total,
        model_clinF_percentiles_results
      ))
}

# Loop to calculate % progressed in CLIN F + ANTI MODEL
for (x in 1:10){
  total = Type2_cohort %>%
      filter(model_clinF_Anti_percentiles == x) %>%
      nrow()
    
    antibody = Type2_cohort %>%
      filter(model_clinF_Anti_percentiles == x & progressed == 1) %>%
      nrow()
    
    Type2_cohort = Type2_cohort %>%
      mutate(model_clinF_Anti_percentiles_results = ifelse(
        model_clinF_Anti_percentiles == x,
        antibody/total,
        model_clinF_Anti_percentiles_results
      ))
}

# Loop to calculate % progressed in CLIN F + ANTI + GRS MODEL
for (x in 1:10){
  total = Type2_cohort %>%
      filter(model_clinF_AntiGRS_percentiles == x) %>%
      nrow()
    
    antibody = Type2_cohort %>%
      filter(model_clinF_AntiGRS_percentiles == x & progressed == 1) %>%
      nrow()
    
    Type2_cohort = Type2_cohort %>%
      mutate(model_clinF_AntiGRS_percentiles_results = ifelse(
        model_clinF_AntiGRS_percentiles == x,
        antibody/total,
        model_clinF_AntiGRS_percentiles_results
      ))
}

# Graphing Calibration plots - Clin F Model
ggplot(Type2_cohort, aes((model_clinF_percentiles)/10, model_clinF_percentiles_results)) +
  geom_point() +
  scale_x_continuous(limits=c(0, 1), breaks=(1:10)/10) +
  scale_y_continuous(limits=c(0, 1)) +
  xlab("Deciles by Distribution") +
  ylab("% Progressed to Insulin <= 3 years") +
  labs(title = "Clinical Features Model Calibration Plot") +
  geom_smooth(method=lm) +
  geom_abline(slope=1, intercept=0)

# Graphing Calibration plots - Clin F + Anti Model
ggplot(Type2_cohort, aes((model_clinF_Anti_percentiles)/10, model_clinF_Anti_percentiles_results)) +
  geom_point() +
  scale_x_continuous(limits=c(0, 1), breaks=(1:10)/10) +
  scale_y_continuous(limits=c(0, 1)) +
  xlab("Deciles by Distribution") +
  ylab("% Progressed to Insulin <= 3 years") +
  labs(title = "Clin F + Anti Model Calibration Plot") +
  geom_smooth(method=lm) +
  geom_abline(slope=1, intercept=0)

# Graphing Calibration plots - Clin F + Anti + GRS Model
ggplot(Type2_cohort, aes((model_clinF_AntiGRS_percentiles)/10, model_clinF_AntiGRS_percentiles_results)) +
  geom_point() +
  scale_x_continuous(limits=c(0, 1), breaks=(1:10)/10) +
  scale_y_continuous(limits=c(0, 1)) +
  xlab("Deciles by Distribution") +
  ylab("% Progressed to Insulin <= 3 years") +
  labs(title = "Clin F + Anti + GRS Model Calibration Plot") +
  geom_smooth(method=lm) +
  geom_abline(slope=1, intercept=0)
  
# Cleaing Environment 
remove(antibody)
remove(total)
```

```{r Clinical Features Model as a First-Line Screening Tool}
#> This chunk is used to investigate the Clinical Features model as a screening tool
#>  - Finds median of Type-2 antibody negative group as a threshold
#>  - Generates a Boxplot and AUC ROC for the model against antibody outcomes

Type2_cohort$Antibody_Positive

#> Find Median of Type 2 Antibody Negative group to use as threshold = 0.018535 (1.8%)
Type2_cohort %>%
  filter(Antibody_Positive == 0) %>%
  select(model_clinF) %>%
  describe()

#> Generating a Boxplot for those who are antibody positive/negative with Clin F Model
ggplot(Type2_cohort,aes(as.factor(Antibody_Positive), model_clinF)) +
  geom_boxplot() +
  xlab("Antibody Positivity") +
  ylab("Clinical Features Model Probabilities") +
  ylim(c(0,1))

# ROC AUC for Clinical Features Model discerning Single-Antibody Positivity
glm.fit = glm(roc_data$Antibody_Positive ~ roc_data$model_clinF, family = binomial())
plot.new()
lines(roc_data$model_clinF, glm.fit$fitted.values)

(roc = roc(roc_data$Antibody_Positive, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')

#> Generating a Boxplot for those who are MULTI - antibody +ve  against Clin F Model
ggplot(Type2_cohort,aes(as.factor(Number_Antibodies >= 2), model_clinF)) +
  geom_boxplot() +
  xlab("Antibody Positivity") +
  ylab("Clinical Features Model Probabilities") +
  ylim(c(0,1))

# ROC AUC for Clinical Features Model discerning MULTI-Antibody Positivity
glm.fit = glm(roc_data$Multi_Antibody_Positive ~ roc_data$model_clinF, family = binomial())
plot.new()
lines(roc_data$model_clinF, glm.fit$fitted.values)

(roc = roc(roc_data$Multi_Antibody_Positive, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

coords(roc, x='best')
```

``` {r FlowChart Numbers}
#> Producing Numbers and percentages for the screening flowchart:
#>  - To use this section, change the following threshold to a value of interest
#>  - Previously used thresholds: 0.005 (bad), 0.018 (good), 0.05 (best), 0.071 (ROC), 0.1
threshold = 0.1

print(paste(
  "Newly Diagnosed n =",
  nrow(Type2_cohort)
))

print(paste(
  "Patients with risk probability >=",
  threshold,
  "=",
  nrow(
    Type2_cohort %>% filter(model_clinF >= threshold)
  ),
  nrow(Type2_cohort %>% filter(model_clinF >= threshold))/nrow(Type2_cohort), "%"
))

print(paste(
  "Patients with risk probability <",
  threshold,
  "=",
  nrow(
    Type2_cohort %>% filter(model_clinF < threshold)
  ),
  nrow(Type2_cohort %>% filter(model_clinF < threshold))/nrow(Type2_cohort), "%"
))

print(paste(
  "# High Risk Antibody Positive =",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1))/nrow(Type2_cohort %>% filter(model_clinF >= threshold)),
  "%"
))

print(paste(
  "# High Risk Antibody Negative =",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0))/nrow(Type2_cohort %>% filter(model_clinF >= threshold)),
  "%"
))


print(paste(
  "# Low-risk patients who progress =",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & progressed == 1)
  ),
  nrow(Type2_cohort %>% filter(model_clinF < threshold & progressed == 1))/
    nrow(Type2_cohort %>% filter(model_clinF < threshold)),
  "%"
))

print(paste(
  "# Low-risk patients who DIDNT progress =",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & progressed == 0)
  ),
  nrow(Type2_cohort %>% filter(model_clinF < threshold & progressed == 0))/
    nrow(Type2_cohort %>% filter(model_clinF < threshold)),
  "%"
))

print(paste(
  "# High-risk, antibody +ve patients who progress",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1 & progressed == 1)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1 & progressed == 1)
  )/ nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1)
  ),
  "%"
))

print(paste(
  "# High-risk, antibody +ve patients who DONT progress",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1 & progressed == 0)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1 & progressed == 0)
  )/ nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1)
  ),
  "%"
))

print(paste(
  "# High-risk, antibody -ve patients who progress",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0 & progressed == 1)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0 & progressed == 1)
  )/ nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0)
  ),
  "%"
))

print(paste(
  "# High-risk, antibody -ve patients who DONT progress",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0 & progressed == 0)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0 & progressed == 0)
  )/ nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0)
  ),
  "%"
))


print(paste(
  "# Total Progression pickup rate (high risk, antibody +ve) =",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1 & progressed == 1)
  ),
  "/",
  nrow(
    Type2_cohort %>%
      filter(progressed == 1)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1 & progressed == 1)
  )/ nrow(
   Type2_cohort %>%
      filter(progressed == 1)
  ),
  "%"
))

#> THIS SECTION USED FOR ANGUS" EXPERIMENTAL POSITIVE PREDICTIVE VALUE FLOWCHART
threshold = 0.1 # Seting Threshold for quick code running

print(paste(
  "# Low Risk antibody positive patients",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & Antibody_Positive == 1)
  ),
  "/",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & Antibody_Positive == 1)
  )/ nrow(
   Type2_cohort %>%
      filter(model_clinF < threshold)
  ),
  "%"
))

print(paste(
  "# Low Risk antibody negative patients",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & Antibody_Positive == 0)
  ),
  "/",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & Antibody_Positive == 0)
  )/ nrow(
   Type2_cohort %>%
      filter(model_clinF < threshold)
  ),
  "%"
))

print(paste(
  "# High Risk antibody positive progression stats",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1 & progressed == 1)
  ),
  "/",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold& Antibody_Positive == 1)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 1 & progressed == 1)
  )/ nrow(
   Type2_cohort %>%
      filter(model_clinF >= threshold& Antibody_Positive == 1)
  ),
  "%"
))

print(paste(
  "# High Risk antibody negative progression stats",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0 & progressed == 1)
  ),
  "/",
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold& Antibody_Positive == 0)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF >= threshold & Antibody_Positive == 0 & progressed == 1)
  )/ nrow(
   Type2_cohort %>%
      filter(model_clinF >= threshold& Antibody_Positive == 0)
  ),
  "%"
))

print(paste(
  "# Low Risk antibody Positive progression stats",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & Antibody_Positive == 1 & progressed == 1)
  ),
  "/",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold& Antibody_Positive == 1)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & Antibody_Positive == 1 & progressed == 1)
  )/ nrow(
   Type2_cohort %>%
      filter(model_clinF < threshold& Antibody_Positive == 1)
  ),
  "%"
))

print(paste(
  "# Low Risk antibody negative progression stats",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & Antibody_Positive == 0 & progressed == 1)
  ),
  "/",
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold& Antibody_Positive == 0)
  ),
  nrow(
    Type2_cohort %>%
      filter(model_clinF < threshold & Antibody_Positive == 0 & progressed == 1)
  )/ nrow(
   Type2_cohort %>%
      filter(model_clinF < threshold& Antibody_Positive == 0)
  ),
  "%"
))

```



```{r Graphing Model Distributions - LEGACY}

Type2_cohort %>%
  select(model_clinF, model_clinF_GAD, model_clinF_IA2, model_clinF_Anti, model_clinF_AntiGRS, Time_to_insulin) %>%
  mutate(Time_to_insulin = ifelse(!is.na(Time_to_insulin), "Progressed", "Did not progress")) %>%
  rename("Clin Features Model" = "model_clinF") %>%
  rename("Clin + GAD" = "model_clinF_GAD") %>%
  rename("Clin + IA2" = "model_clinF_IA2") %>%
  rename("Clin + Antibodies" = "model_clinF_Anti") %>%
  rename("Clin + Anti + GRS" = "model_clinF_AntiGRS") %>%
  gather(key = key, value = value, -Time_to_insulin) %>%
  ggplot2::ggplot() +
  geom_violin(aes(x = key, y = value,)) +
  xlab('Models') +
  ylab('Probability') +
  geom_smooth(aes(x = key, y = value), method = 'lm') +
  facet_wrap(~ Time_to_insulin)

```


``` {r Exploring Clin + Anti + GRS Deciles - OPTIONAL}
#> Primary aim of this section is to explore why the model was able to detect some
#> individuals who progressed, but not others
#> So looking at model deciles within the progressed cohort

#> Making temp cohort for desc analysis
type2_progressed = Type2_cohort %>%
  filter(progressed == "Progressed") %>%
  mutate(decile = dplyr::ntile(model_clinF_AntiGRS, 10))

table = print(
  CreateTableOne(
    data=type2_progressed,
    vars = c("BMI", "AgeatDiagnosis", "GRS", "HbA1c_at_diagnosis", "model_clinF",
             "model_clinF_GAD", "model_clinF_IA2", "model_clinF_Anti",
             "model_clinF_AntiGRS", "Number_Antibodies"),
    strata = "decile"
  ),
  test = FALSE,
  noSpaces = TRUE
)

write.csv(table, file = "testTable.csv")

#Removing temporary variables
remove(table)
remove(type2_progressed)
```

``` {r Cleaning environment}
remove(roc)
remove(roc_data)
```



## Unused Legacy Code
``` {r Legacy Unused Code}
#### Graphing Violion models against eachother #####################
#> Clin features model
#> Clin features + autoantibodies (GAD IA2)
#> compared using gg VIOLIN Plot
not_insulin %>%
  filter(!is.na(Model4Prob) & !is.na(Model1Prob) & !is.na(Model5Prob)) %>%
  select(Model1Prob, Model4Prob, Model5Prob) %>%
  rename("Clin Features Model" = "Model1Prob") %>%
  rename("Clin + Antibody Model" = "Model4Prob") %>%
  rename("Clin + Anti + GRS Model" = "Model5Prob") %>%
  gather() %>%
  ggplot2::ggplot() +
  geom_violin(aes(x = key, y = value)) +
  xlab('Models') +
  ylab('Probability') +
  geom_smooth(aes(x = key, y = value), method = 'lm')

#### Obtaining P-value for ROC comparisons
roc.test(roc, roc1)

################################################################################
################# Sub Investigation: Clin Features Model #######################
################ Able to Detect Antibody Positive Patients #####################
################################################################################
### - Clinical Model distinguishes pretty well for those who would be 
###   antibody positive
###    > Antibody positive OUT OF ALL 3 (GAD, IA2, ZNT8)
### - Therefore Clin model can be step 1 of 2 step process:
###    > Patient qualifies for antibody testing from Clinical Model
###    > Patient's antibody results come back and interpreted in second model
###    > future: create new model based on HOW MANY antibodies are positive
### - To test this:
###    > AUC ROC curve for Clinical Features model and outcome is antibody +
###    > Calibration plot for the same
################################################################################
# AUC ROC Curve for Antibody #################################
#Estabishing outcome = if ANY 3 antibody+ is positive outcome
not_insulin = not_insulin %>%
  mutate(antibody_positive = ifelse(GADA_Status == 1 | IA2A_Status == 1 | ZNT8_Status == 1, 1, 0))

#Estabishing outcome = if ALL 3 antibody- is negative outcome
not_insulin = not_insulin %>%
  mutate(antibody_positive = ifelse(GADA_Status == 0 & IA2A_Status == 0 & ZNT8_Status == 0, 0, 1))

#Filtering to ensure equal length
roc_data = not_insulin %>%
  filter(!is.na(antibody_positive) & !is.na(Model1Prob))

#Storing the logistic regression results
glm.fit = glm(roc_data$antibody_positive ~ roc_data$Model1Prob, family = binomial())
plot.new()
lines(roc_data$Model4Prob, glm.fit$fitted.values)

(roc = roc(roc_data$antibody_positive, glm.fit$fitted.values,
           #auc.polygon=TRUE,
           plot=TRUE,
           #smoothed=TRUE,
           #ci=TRUE,
           #ci.alpha = 0.9,
           #max.auc.polygon=TRUE,
           #print.auc=TRUE,
           #show.thres=TRUE
           ))

#Getting threshold, sensitivity and specificity
coords(roc, x='best')




# Clin Features Calibration #############################
deciles = list(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0)
results = list()

for (x in 1:10){
  # Need to handle first and last number specially
  if (x == 1) {
    print('# Of patients with Antibodies within first Decile = ')
    total = not_insulin %>%
      filter(Model1Prob <= 0.1) %>%
      nrow()
    
    antibody = not_insulin %>%
      filter(Model1Prob <= 0.1 & antibody_positive == 1) %>%
      nrow()
    results[1] = antibody/total
    # Need to handle first and last number specially
  } 
  else if (x == 10){
    print('# Of patients progressed to Insulin within last Decile = ')
    total = not_insulin %>%
      filter(Model1Prob > 0.9) %>%
      nrow()
    
    antibody = not_insulin %>%
      filter(Model1Prob > 0.9 & antibody_positive == 1) %>%
      nrow()
    results[10] = antibody / total
    # Index 2-9 = core loop
  } 
  else {
    print(paste('# Of patients antibody positive within Decile: ', x, ' = '))
    total = not_insulin %>%
      filter(Model1Prob > deciles[x-1] & Model1Prob <= deciles[x]) %>%
      nrow()
    
    antibody = not_insulin %>%
      filter(Model1Prob > deciles[x-1] & Model1Prob <= deciles[x] & antibody_positive == 1) %>%
      nrow()
    
    results[x] = antibody / total
  }
}

plot(deciles, results,
     xlim = c(0,1),
     ylim = c(0,1),
     main = 'Clinical Features Model',
     xlab = 'Model Probability',
     ylab = '% antibody positive')

#For r-squared value
summary(lm(unlist(results) ~ unlist(deciles), data=not_insulin))

#graph trendline and print equation
calibration_plot = lm(unlist(results) ~ unlist(deciles), data=not_insulin)
lines(unlist(deciles),
      predict(calibration_plot),
      col = 2,
      lwd = 2)
(paste("y =", coef(calibration_plot)[[1]], "+", coef(calibration_plot)[[2]], "* x"))


################################################################################
##################### Model 4 and 5 in Antibody+ ###############################
################################################################################
### - If those are already antibody positive, is there any use in model?
### - Run model in those antibody positive and see result
################################################################################
#Filtering for only those with antibodies
roc_data = not_insulin %>%
  filter(Number_Antibodies > 0)

#Descriptive Stats ########################################
nrow(roc_data)

#look at those who did progress
roc_data %>%
  filter(progressed == 0) %>%
  select(GRS, BMI, AgeatDiagnosis, HbA1c_at_diagnosis, Model4Prob) %>%
  describe()

roc_data %>%
  filter(progressed == 0) %>%
  nrow()

#ROC #########################################
roc_data = not_insulin %>%
  filter(!is.na(progressed) & !is.na(Model4Prob) & Number_Antibodies >= 1)

#Storing the logistic regression results
glm.fit = glm(roc_data$progressed ~ roc_data$Model4Prob, family = binomial())

#Graphing ROC
plot.new()
lines(roc_data$Model4Prob, glm.fit$fitted.values)
(roc = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

#Getting threshold, sensitivity and specificity
coords(roc, x='best')

# Model 5 in Antibody Positive! ROC Curve ##################################
#Storing the logistic regression results
roc_data = not_insulin %>%
  filter(!is.na(progressed) & !is.na(Model5Prob) & Number_Antibodies >= 1)

glm.fit = glm(roc_data$progressed ~ roc_data$Model5Prob, family = binomial())
plot.new()
lines(roc_data$Model5Prob, glm.fit$fitted.values)

(roc1 = roc(roc_data$progressed, glm.fit$fitted.values, auc=TRUE, plot=TRUE))

#Getting threshold, sensitivity and specificity
coords(roc, x='best')

#COmpare two ROCS for p-value
roc.test(roc, roc1)

#Calibration ####################################
deciles = list(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0)
results = list()

for (x in 1:10){
  # Need to handle first and last number specially
  if (x == 1) {
    print('# Of patients progressed to Insulin within first Decile = ')
    total = roc_data %>%
      filter(Model4Prob <= 0.1) %>%
      nrow()
    
    progressed = roc_data %>%
      filter(Model4Prob <= 0.1 & progressed == 1) %>%
      nrow()
    results[1] = progressed/total
    # Need to handle first and last number specially
  } else if (x == 10){
    print('# Of patients progressed to Insulin within last Decile = ')
    total = roc_data %>%
      filter(Model4Prob > 0.9) %>%
      nrow()
    
    progressed = roc_data %>%
      filter(Model4Prob > 0.9 & progressed == 1) %>%
      nrow()
    results[10] = progressed / total
    # Index 2-9 = core loop
  } else {
    print(paste('# Of patients progressed to Insulin within Decile: ', x, ' = '))
    total = roc_data %>%
      filter(Model4Prob > deciles[x-1] & Model4Prob <= deciles[x]) %>%
      nrow()
    
    progressed = roc_data %>%
      filter(Model4Prob > deciles[x-1] & Model4Prob <= deciles[x] & progressed == 1) %>%
      nrow()
    
    results[x] = progressed / total
  }
}

plot(deciles, results,
     xlim = c(0,1),
     ylim = c(0,1),
     main = 'Clinical Features + Antibody Model',
     xlab = 'Model Probability',
     ylab = '% progressed to insulin')

#graph trendline and print equation
calibration_plot = lm(unlist(results) ~ unlist(deciles), data=roc_data)
lines(unlist(deciles),
      predict(calibration_plot),
      col = 2,
      lwd = 2)
(paste("y =", coef(calibration_plot)[[1]], "+", coef(calibration_plot)[[2]], "* x"))

#For r-squared value
summary(lm(unlist(results) ~ unlist(deciles), data=roc_data))

#Descriptive Stats for Calibration ############################
nrow(roc_data)

#How many progressed
roc_data %>%
  filter(progressed == 1) %>%
  nrow()

#How many were over threshold
roc_data %>%
  filter(Model4Prob >= 0.1159171 & progressed == 1) %>%
  nrow()

################################################################################
################## Finding Mean duration of follow up ##########################
################################################################################
### - How long was the average time from diagnosis to final follow up?
### - A LOT of date formatting :(
################################################################################
#Create new column
not_insulin$duration_follow_up = NA

#Binary variable if they have V3 data
not_insulin$HaveV3Data = NA
not_insulin = not_insulin %>%
  mutate(HaveV3Data = ifelse(V3Date_Contacted != '' & !is.na(V3Date_Contacted), 1, 0))

#Binary variable if they have V2 data
not_insulin$HaveV2Data = NA
not_insulin = not_insulin %>%
  mutate(HaveV2Data = ifelse(V2Date_Contacted != '' & !is.na(V2Date_Contacted), 1, 0))

#Calculating difference between dates for patients who have V3
V3_patients = not_insulin %>%
  filter(HaveV3Data == 1) %>%
  filter(DateofDiagnosis != '' & !is.na(DateofDiagnosis)) %>%
  mutate(duration_follow_up = difftime(
    as.Date(V3Date_Contacted, "%m/%d/%Y"),
    as.Date(DateofDiagnosis, "%d-%B-%y"), 
    units = 'weeks'), NA)

#Calculating difference between dates for patients who dont have V3 data
V2_patients = not_insulin %>%
  filter(HaveV3Data == 0 & HaveV2Data == 1) %>%
  filter(DateofDiagnosis != '' & !is.na(DateofDiagnosis)) %>%
  mutate(duration_follow_up = difftime(
    as.Date(V2Date_Contacted, "%d-%b-%y"),
    as.Date(DateofDiagnosis, "%d-%B-%y"), 
    units = 'weeks'), NA)

updated_not_insulin = rbind.data.frame(V3_patients, V2_patients)
updated_not_insulin %>%
  mutate(duration_follow_up = as.numeric(duration_follow_up)) %>%
  select(duration_follow_up) %>%
  describe()






```

